<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>SFV FOOTSIES LOL</title>
<style>

  body {
    background-color: #000;
    color: #fff;
  }

  path {
    stroke-width: 1px;
    stroke: #333;
    fill: #ddd;
    vector-effect: non-scaling-stroke;
  }

  td {
    padding: 5px;    
    font: 14px sans-serif;
    text-align: left;
    vertical-align: top;
  }

  #FOOTSIES td {
    padding: 5px;    
    font: 10px sans-serif;
    text-align: center;
    vertical-align: top;
    color: #ccc;
  }

  /*.R0 { background-color: #111;}*/
  #FOOTSIES td.R0 { color: #333; }
  #FOOTSIES td.R1 { /*color: #999;*/ /*color: #00c;*/ background-color: #003; }
  #FOOTSIES td.R2 { /*color: #999;*/ /*color: #c00;*/ background-color: #300; }
  #FOOTSIES td.R3 { /*color: #999;*/ /*color: #cc0;*/ background-color: #330; }
  #FOOTSIES td.R10 { /*color: #999;*/ color: #009; /*background-color: #001;*/ }
  #FOOTSIES td.R20 { /*color: #999;*/ color: #900; /*background-color: #100;*/ }
  #FOOTSIES td.R11 { /*color: #999;*/ color: #009; /*background-color: #001;*/ }
  #FOOTSIES td.R22 { /*color: #999;*/ color: #900; /*background-color: #100;*/ }

  #FOOTSIES td.R0.RH, #FOOTSIES td.R0:hover { color: #999; }
  #FOOTSIES td.R1.RH, #FOOTSIES td.R1:hover { color: #fff; background-color: #009 !important; }
  #FOOTSIES td.R2.RH, #FOOTSIES td.R2:hover { color: #fff; background-color: #900 !important; }
  #FOOTSIES td.R3.RH, #FOOTSIES td.R3:hover { color: #fff; background-color: #990 !important; }
  #FOOTSIES td.R10.RH, #FOOTSIES td.R10:hover { color: #00f; background-color: #009 !important; }
  #FOOTSIES td.R20.RH, #FOOTSIES td.R20:hover { color: #f00; background-color: #900 !important; }
  #FOOTSIES td.R11.RH, #FOOTSIES td.R11:hover { color: #00f; }
  #FOOTSIES td.R22.RH, #FOOTSIES td.R22:hover { color: #f00; }


  #BOXDOX rect {
    stroke-width: 1px;
    /*stroke: #333;*/
    fill: none;
    /*opacity: 0.8;*/
    mix-blend-mode: screen;
    vector-effect: non-scaling-stroke;
  }

  #ALL1 rect, #ALL2 rect {
    /*stroke-width: 1px;*/
    /*stroke: #333;*/
    /*fill: none;*/
    /*opacity: 0.8;*/
    /*mix-blend-mode: normal;*/
    /*vector-effect: non-scaling-stroke;*/
  }

  .fgray { fill: #111;}
  .fred { fill: #300; }
  .fgreen { fill: #030; }
  .fblue { fill: #003; }
  .fcyan { fill: #033; }
  .fyellow { fill: #330; }

  .hred { fill: #600; }
  .hgreen { fill: #060; }
  .hblue { fill: #006; }
  .hcyan { fill: #066; }
  .hyellow { fill: #660; }

  .gray { stroke: #333; }
  .red { stroke: #f00; }
  .green { stroke: #0f0; }
  .blue { stroke: #00f; }
  .cyan { stroke: #0ff; }

  .p2gray { stroke: #333; }
  .p2red { stroke: #f66; }
  .p2green { stroke: #6f6; }
  .p2blue { stroke: #66f; }
  .p2cyan { stroke: #6ff; }

  .allred { stroke: #f00; }
  .ucred { stroke: #c00; }
  .ucblue { stroke: #00c; }

  #buttons {
    width: 70%;
    float: left;
    padding-left: 5%;
  }

  #controls {
    width: 100%;
    /*float: left;*/
    margin-top: 10px;
  }

  #controls div{
    white-space: nowrap;
    display: inline-block;
  }

  #controls, #buttons, #BOXDOX text {
    /*position: absolute;*/
    /*width: 240px*/;
    font: 10px sans-serif;
  }

  #controls span, #buttons span,
  #controls label, #buttons label {
    position: relative;
    top: -5px;
    padding: 5px;
    display: inline-block;
    width: 20px;
  }

  #m1 input, #m2 input {
    width: 50px;
  }

  #buttons button {
    font: 10px sans-serif;
    padding: 5px;
    width: 70px;
  }

  #buttons .buttons {
    width: 50%;
    float: left;
  }

  .LOL text {
    text-anchor: middle;
    fill: #999;
    font: 8px sans-serif;
  }

  .LOL rect:hover {
    stroke: #fff;
  }

  #svg {
    text-align: center;
  }
</style>
<style type="text/css">

  div#PLAYERS, div#UCHITBOX, div#FOOTSIES {
    width: 100%;
    text-align: center;
    white-space: nowrap;
  }
  div#FOOTSIE {
    width: 960px;
    margin: 0 auto;
  }
  div.PLAYER {
    /*max-width: 45%;*/
    display: inline-block;
  }
  div.UCHITBOX {
    max-width: 45%;
    display: inline-block;
    vertical-align: top;
  }

  div#PLAYERS, div#UCHITBOX {
    width: 100%;
    text-align: center;
  }

  div.ROW {    
    white-space: nowrap;
  }
  .MOVES div:nth-of-type(3), .MOVES div:nth-of-type(5) {
    padding-top: 10px;
  }
  .DIALS div:nth-of-type(1) {
    padding-top: 10px;
  }

  button.DIAL {
    padding: 5px;
    margin: 3px;
    background-color: #999;
  }
  button.CHAR {
    padding: 5px;
    margin: 3px;
    /*width: 8%;*/
    background-color: #999;
  }
  button.MOVE {
    padding: 7px;
    margin: 3px;
    /*width: 5%;*/
    /*font-size: 10px;*/
    background-color: #eee;
  } 

  button.MOVE:nth-of-type(3), button.MOVE:nth-of-type(6) {
    margin-right: 10px;
  }
  button.DIAL:nth-of-type(2), button.DIAL:nth-of-type(4), button.DIAL:nth-of-type(8), button.DIAL:nth-of-type(10), button.DIAL:nth-of-type(12) {
    margin-right: 10px;
  }

  button.DUP {
    background-color: #999;
  }
  button.SEL {
    background-color: #ffc;
  }

  button.FRAME {
    padding: 7px;
    margin: 3px;
    width: 50px;
    background-color: #999;
  }

  button.FRAMET {
    background-color: #999;
  }  
  button.FRAMEL {
    background-color: #eee;
  }
  button.FRAMEM {
    background-color: #ccc;
  }
  button.FRAMEH {
    background-color: #aaa;
  }

  button.UC {
    background-color: #cc9;
  }

  .MOVES {
    padding-top: 10px;
  }
</style>
</head>
<body>
<div id="PLAYERS">
<div id="P1" class="PLAYER"><div class="CHARS"></div><div class="MOVES"></div></div>
<div id="P2" class="PLAYER"><div class="CHARS"></div><div class="MOVES"></div></div>
<div id="P0"><div class="DIALS"></div></div>
<div id="controls"></div>
</div>
<div id="svg"></div>
<div id="FOOTSIES">
<div id="FOOTSIE">
</div>
</div>
<div id="UCHITBOX">
<div id="UC1" class="UCHITBOX"></div>
<div id="UC2" class="UCHITBOX"></div>
</div>
<script src="d3.min.js"></script>
<script>

  var UCME = !true;
  var BOXLEN = 48;
  var BOXDOX = [[],[],[]];
  var CHARS = [
  ["ALX","BLR", "BLR2", "BRD", "BRD2", "CMY", "CNL", "CNL2", "DSM", "FAN", "KEN", "KRN"],
  ["LAR", "NCL", "NCL2", "NSH", "RMK", "RSD", "RYU", "RYU2", "VEG", "VEG2", "ZGF"],
  ];
  var MOVES = [
  ["4T", "5T", "ALL", "P1", "P2", "FOOTSIES", "HOVER"], //, "ADV0", "ADV+", "ADV-", "ADV="],
  [ "4D", "6D", "2C", "5S", "4W", "6W", "7J", "8J", "9J"],
  ["4LP", "4MP", "4HP", "5LP", "5MP", "5HP", "6LP", "6MP", "6HP"],
  ["4LK", "4MK", "4HK", "5LK", "5MK", "5HK", "6LK", "6MK", "6HK"],
  ["1LP", "1MP", "1HP", "2LP", "2MP", "2HP", "3LP", "3MP", "3HP"],
  ["1LK", "1MK", "1HK", "2LK", "2MK", "2HK", "3LK", "3MK", "3HK"],
  ];
  var DIALS = [
  ["ADV=", "ADV0", "ADV+", "ADV-", "X1 -2.0", "X1 -1.5", "X1 -1.0", "X1 -0.5", "FRAME1-", "FRAME1+", "FRAME2-", "FRAME2+", "FRAME-","FRAME+"]
  ];

  var DDIV = d3.selectAll(".DIALS").datum(function(d,i){return i+1;});
  DDIV.selectAll("div").data(DIALS).enter().append("div").attr("class","ROW")
      .selectAll("button").data(function(d){return d;}).enter().append("button").attr("class", function(d,i){return "DIAL"})      
      .text(function(d,i){return d;})
      .on("click", function(d,i) { 

        var f = 1*prop("f"); 
        var adv = 1*prop("adv"); 

        if (d == "ALL") {

        } else if (d == "X1 -0.5") {
          prop("x1", -0.5);
        } else if (d == "X1 -1.0") {
          prop("x1", -1.0);
        } else if (d == "X1 -1.5") {
          prop("x1", -1.5);
        } else if (d == "X1 -2.0") {
          prop("x1", -2.0);
        } else if (d == "ADV0") {
          prop("adv", 0);
        } else if (d == "ADV-") {
          prop("adv", adv-1);
        } else if (d == "ADV+") {
          prop("adv", adv+1);
        } else if (d == "FRAME-") {
          prop("f", f-1);
        } else if (d == "FRAME+") {
          prop("f", f+1);
        } else if (d == "FRAME1-") {
          if (adv<=0) { prop("adv", adv-1); }
          if (adv>0) { prop("adv", adv-1); prop("f", f-1); }
        } else if (d == "FRAME1+") {
          if (adv<0) { prop("adv", adv+1); }
          if (adv>=0) { prop("adv", adv+1); prop("f", f+1); }
        } else if (d == "FRAME2-") {
          if (adv>=0) { prop("adv", adv+1); }
          if (adv<0) { prop("adv", adv+1); prop("f", f-1); }
        } else if (d == "FRAME2+") {
          if (adv>0) { prop("adv", adv-1); }
          if (adv<=0) { prop("adv", adv-1); prop("f", f+1); }
        } else if (d == "ADV=") {
          var s1 = mhit1(BOXDOX[1][1*prop("m1")]);
          var s2 = mhit1(BOXDOX[2][1*prop("m2")]);
          var s0 = s1-s2;
          prop("adv", s0);
          if (s0<0) prop("f", s2+2);
          else if (s0>0) prop("f", s1+2);
        }

        //d3.select("#f").select("input").node().focus();
        render(rparams());

      } );

  var CDIV = d3.selectAll(".CHARS").datum(function(d,i){return i+1;});
  CDIV.selectAll("div").data(CHARS).enter().append("div").attr("class","ROW")
      .selectAll("button").data(function(d){return d;}).enter().append("button").attr("class","CHAR")
      .on("click",function(d,i){
        var p = d3.select(this.parentNode.parentNode).datum();
        d3.select("#P"+p).selectAll(".CHAR").classed("SEL",false);
        d3.select(this).classed("SEL",true);
        cload(d,p);
      })
      .text(function(d,i){return d;});

  var MDIV = d3.selectAll(".MOVES").datum(function(d,i){return i+1;});
  MDIV.selectAll("div").data(MOVES).enter().append("div").attr("class","ROW")
      .selectAll("button").data(function(d){return d;}).enter().append("button")
      .attr("class", function(d,i){        
        var p = d3.select(this.parentNode.parentNode).datum();
        return "MOVE MOVE" + d + " DUP" + (d=="FOOTSIES" || d=="HOVER" || d=="P"+p ? " UC" : "");
      })
      .text(function(d,i){return d;})
      .on("click", function(d,i) { 
        var p = d3.select(this.parentNode.parentNode).datum();

        // console.log(p,d,i);
        var m = BOXDOX[p].filter(function(e,i){ return e.p == p-1 && e.m == d;});
        
        if (m.length == 0) { 
          // console.log(m);
          if (d == "ALL") {
            //d3.select("#P"+p).selectAll("button.MOVE").classed("SEL",false);
            d3.select(this).classed("UC",true);
            allhit(p);
          } else if (d == "P1") {
            d3.select(this).classed("UC",!d3.select(this).classed("UC"));
            d3.select("#P"+p).select(".MOVEP2").classed("UC",!d3.select(this).classed("UC"));
            stage(rparams());
          } else if (d == "P2") {
            d3.select(this).classed("UC",!d3.select(this).classed("UC"));
            d3.select("#P"+p).select(".MOVEP1").classed("UC",!d3.select(this).classed("UC"));
            stage(rparams());
          } else if (d == "FOOTSIES") {
            var c = !d3.select(this).classed("UC");
            d3.selectAll(".MOVEFOOTSIES").classed("UC",c)
            d3.select("#FOOTSIES").style("display", c ? "" : "none");
          } else if (d == "HOVER") {
            var c = !d3.select(this).classed("UC");
            d3.selectAll(".MOVEHOVER").classed("UC",c);
            if (c == true) {
              d3.selectAll(".RH").classed("RH",false);
            }
          }
          return;
        }

        // var allsel = d3.select("#P"+p).select(".MOVEALL").classed("SEL");
        d3.select("#P"+p).selectAll("button.MOVE").classed("SEL",false);
        d3.select(this).classed("SEL",true);
        // if (allsel) d3.select("#P"+p).select(".MOVEALL").classed("SEL",true);

        var s0 = mhit1(m[0]);
        prop("m"+p, m[0].i);

        var adv = 1*prop("adv");
        if (p==1) prop("f", s0+2+(adv<0 && s0+2>adv?-adv:0));
        else if (p==2) prop("f", s0+2+(adv<0?0:adv));
        d3.select("#f").select("input").node().focus();
        render(rparams());

        if (!UCME) UCFOOTSIES(prop("m1"),prop("m2"));
        else if (UCME) UCFOOTSIES(prop("m1"),prop("m2"));
        else if (UCME && p == 1) UCFOOTSIES(prop("m1"),-3);
        else if (UCME && p == 2) UCFOOTSIES(-3,prop("m2"));

      });

  function mhit1(m) {
    var s0 = m.f[2].s0;
    if (s0 == 0 || s0 != m.f[3].s0) {
      var s0f = m.f.filter(function(e,i){ return e.c5.filter(function(c){ return c.t!=4; }).length > 0; });
      if (s0f.length>0) s0 = s0f[0].sf;
    }
    return s0;
  }

  function prop(p,v) {
    if (arguments.length == 1) return d3.select("#"+p).select("input").property("value");
    d3.select("#"+p).select("input").property("value", v);
    d3.select("#"+p).select("span").text(formatkv(p,v));
  }

  function cload(c,p) {

    console.log(c,p);

    d3.text("LOL_"+c+"_"+c+".json", function(error,data) {

      if (error!=null) return;

      BOXDOX[p] = eval(data);
      BOXDOX[p].forEach(function(m,mi){ m.i = mi; });
      if (BOXDOX[1].length == 0) BOXDOX[1] = BOXDOX[p];
      if (BOXDOX[2].length == 0) BOXDOX[2] = BOXDOX[p];
      render(rparams());

      var dup = [];
      var mb = {};
      var mblen = 0;
      BOXDOX[p].forEach(function(m,mi){
        // if (m.f[0].sf != 17) console.log(m);
        if (dup.indexOf(m.f[2].s) >= 0) ;//console.log(m);
        else dup.push(m.f[2].s);

        if (mb[m.f[2].s] && mb[m.f[2].s].indexOf(m.m) < 0) { mb[m.f[2].s].push(m.m); mblen++; }
        else { mb[m.f[2].s] = [m.m]; mblen++; }
      });

      for (var key in mb) {
        var m = mb[key]
        // console.log(key, m);
        m.forEach(function(b,bi){
          if (bi==0) { d3.select("#P"+p).selectAll(".MOVE"+b).classed("DUP",false); }
          else { d3.select("#P"+p).selectAll(".MOVE"+b).classed("DUP",true); }
        });
      }

      //d3.select("#P"+p).selectAll("button.MOVE").classed("SEL",false);

      // if (d3.select("#P"+p).select(".MOVEALL").classed("SEL")) {
      //   allhit(p);
      // }
      UCHITBOX(p);

      if (UCME && c=="KRN") cload("KEN",2);
      else if (UCME && c=="KEN") UCFOOTSIES(18,47);
      else if (UCME && c=="KEN") UCFOOTSIES(-3,44);
    });

  }

  function rparams() {

    return {
        m1: d3.select("#m1").select("input").property("value"), 
        m2: d3.select("#m2").select("input").property("value"), 
        adv: d3.select("#adv").select("input").property("value"), 
        x1: d3.select("#x1").select("input").property("value"), 
        f: d3.select("#f").select("input").property("value"), 
        };
  }

  function FOOTSIESENTER(d,i) {
    if (d3.selectAll(".MOVEHOVER").classed("UC")==false) return;
    prop("x1",d.x1);
    prop("adv",d.adv);
    prop("m1",d.m1);
    prop("m2",d.m2);
    prop("f",d.f);
    render(rparams());
  }

  function FOOTSIESCLICK(d,i) {
    prop("x1",d.x1);
    prop("adv",d.adv);
    prop("m1",d.m1);
    prop("m2",d.m2);
    prop("f",d.f);
    render(rparams());    
    var c = d3.select(this).classed("RH");
    if (c) {
      d3.selectAll(".MOVEHOVER").classed("UC",true);  
      d3.selectAll(".RH").classed("RH",false);
    } else {
      d3.selectAll(".MOVEHOVER").classed("UC",false);
      d3.selectAll(".RH").classed("RH",false);
      d3.select(this).classed("RH",true);
    }
  }

  function UM(p) {
    var dup = [];
    var mb = {};
    var mblen = 0;
    var um = [];
    BOXDOX[p].forEach(function(m,mi){
      if (m.p+1!=p) 
        return;

      if (dup.indexOf(m.f[2].s) >= 0) ;
      else dup.push(m.f[2].s);

      if (mb[m.f[2].s] && mb[m.f[2].s].indexOf(m.m) < 0) { mb[m.f[2].s].push(m.i); mblen++; }
      else { mb[m.f[2].s] = [m.i]; mblen++; um.push(m.i); }
    });
    return um;
  }

  function FOOTSIE(f1,f2,x1,x2) {
    for (var c1=0;c1<f1.c5.length;c1++) {
      var b1 = f1.c5[c1];
      if (b1.t!=4 && b1.t!=3) {      
        var r1 = {left:b1.rx+x1,top:b1.ry,right:b1.rx+x1+b1.rw,bottom:b1.ry+b1.rh};
        for (var c2=0;c2<f2.c6.length;c2++) {
          var b2 = f2.c6[c2];
          if ((b1.t == 2 && b2.t == 4) || (b1.t == 0 && b2.t != 4)) {          
            var r2 = {left:b2.rx+x2,top:b2.ry,right:b2.rx+x2+b2.rw,bottom:b2.ry+b2.rh};
            var hit = !(r2.left > r1.right || r2.right < r1.left || r2.top > r1.bottom || r2.bottom < r1.top);
            if (hit) return 1; //b1.t == 2 ? 1000 : b1.s;
          }
        }
      }
    }
    return 0;
  }

  function FOOTSIES(m1,m2,x,adv) {

    var priority = {T:1000,H:50,M:40,L:30};
    var r = 0;

    var b1 = m1;
    var b2 = m2;

    var x1 = +x-b1.x;
    var x2 = -x-b2.x;
          
    var adv = Math.floor(adv);

    var fmax = Math.max(b1.f.length,b2.f.length);
    for(var f=0;f<fmax;f++) {
      var f1 = f;
      var f2 = f;
      if (adv > 0) f2 -= adv;
      if (adv < 0) f1 += adv;
      if (f1 < 0) f1 = 0;
      if (f2 < 0) f2 = 0;
      if (f1 > b1.f.length-1) f1 = b1.f.length-1;
      if (f2 > b2.f.length-1) f2 = b2.f.length-1;

      var r1 = FOOTSIE(b1.f[f1],b2.f[f2],x1,x2);
      var r2 = FOOTSIE(b2.f[f2],b1.f[f1],x2,x1);

      if (r1 > 0 || r2 > 0) {

        var p1 = r1 == 0 ? 0 : priority[b1.m.charAt(1)];
        var p2 = r2 == 0 ? 0 : priority[b2.m.charAt(1)];

        if (p1 > p2) r = 1;
        else if (p1 < p2) r = 2;
        else if (p1 == p2) r = 3;
      }

      if (r>0) {

        if (r == 1 && (b2.f[f2].si < 100 || b2.f[f2].sf > b2.f[f2].s1)) return {r:f2>1?11:10,f:f,h:""};
        if (r == 2 && (b1.f[f1].si < 100 || b1.f[f1].sf > b1.f[f1].s1)) return {r:f1>1?22:20,f:f,h:""};

        var h = "";
        var h1 = (b1.f[f1].sf - b1.f[f1].s0);
        var h2 = (b2.f[f2].sf - b2.f[f2].s0);
        
        if (r == 1) h = h2<0?"CH":p2>0?"P":"";
        if (r == 2) h = h1<0?"CH":p1>0?"P":"";
        if (r == 1 && h1 > 0 ) h = h + "+" + h1;
        if (r == 2 && h2 > 0 ) h = h2 + "+" + h;
        if (r == 3 && (h1 > 0 && h2 > 0) ) h = "+" + h1 + " " + h2 + "+";
        else if (r == 3 && h1 > 0 ) h = "+" + h1;
        else if (r == 3 && h2 > 0) h = h2 + "+";

        return {r:r,f:f,h:h};
      }
    }

    return {r:0,f:0,h:""};
  }

  function UCFOOTSIES(m1,m2) {

    console.log("FOOTSIES");

    var um1 = UM(1);
    var um2 = UM(2);

    var dScale1 = d3.scale.linear().range(['#003', '#006']).domain([1.0, 4.0]);
    var dScale2 = d3.scale.linear().range(['#300', '#600']).domain([1.0, 4.0]);
    var xScale1 = d3.scale.linear().range(['#003', '#006']).domain([0.5, 2.0]);
    var xScale2 = d3.scale.linear().range(['#300', '#600']).domain([0.5, 2.0]);
    var mScale1 = d3.scale.linear().range(['#003', '#006']).domain([0, um1.length]);
    var mScale2 = d3.scale.linear().range(['#300', '#600']).domain([0, um2.length]);

    var i1 = 1;
    var i2 = 1;
    var i = 1;
    var th = [//"S0","S1","S2",
    "M1","X1","+7","+6","+5","+4","+3","+2","+1","0","1+","2+","3+","4+","5+","6+","7+","X2","M2"];

    if (m1 < 0) {
      th = ["ADV","X1"];
      for (i1=0;i1<um1.length;i1++) { th.push(BOXDOX[1][um1[i1]].m); }
      th.push("X2");
      th.push("M2");      
    }
    if (m2 < 0) {
      th = ["M1","X1"];
      for (i2=0;i2<um2.length;i2++) { th.push(BOXDOX[2][um2[i2]].m + "<br/>" + BOXDOX[2][um2[i2]].f[3].si); }
      th.push("X2");
      th.push("ADV");      
    }

    var F = d3.select("#FOOTSIE");
    F.selectAll("*").remove();
    var FT = F.append("table").style("width","100%").style("table-layout","fixed");
    FT.append("tr").style("color","#999").selectAll("td").data(th).enter().append("td").html(function(d,i){return d;})

    if (m1 < 0)    
    {
      adv = m1;

      //for (i2=0;i2<um2.length;i2++) {
      for (i2=0;i2<1;i2++) {

        //m2 = um2[i2];
        var b2 = BOXDOX[2][m2];

        for (x=0.5;x<2.0;x+=0.05) {

          var tr = FT.append("tr").style("background-color",i++%2==0?"#222":"#111");   
          tr.append("td").text(adv).style("background-color",mScale1(1));        
          tr.append("td").text(-x.toFixed(2)).style("background-color",xScale1(x));

          for (i1=0;i1<um1.length;i1++) {

            m1 = um1[i1];
            var b1 = BOXDOX[1][m1];
            
            var r = FOOTSIES(b1,b2,-x,adv);
            tr.append("td").text((x*2).toFixed(1)).classed("R"+r.r,true)
              .datum({x1:-x,adv:adv,m1:m1,m2:m2,f:r.f})
              .on("mouseenter",FOOTSIESENTER).on("click",FOOTSIESCLICK);
          }

          tr.append("td").text(+x.toFixed(2)).style("background-color",xScale2(x));
          tr.append("td").text(b2.m).style("background-color",mScale2(i2));
        }
      }


      var FT = F.append("table").style("width","50%").style("table-layout","fixed");
      FT.append("tr").style("color","#999").selectAll("td").data(["M2","S2","F2","D1","D2","M1"]).enter().append("td").html(function(d,i){return d;})

      for (i2=0;i2<um2.length;i2++) {
        
        m2 = um2[i2];
        var b2 = BOXDOX[2][m2];

        for (i1=0;i1<um1.length;i1++) {

          m1 = um1[i1];
          var b1 = BOXDOX[1][m1];

          var d1 = 0.0;
          var d2 = 0.0;

          var tr = null;
          var td2 = null;

          for (x=0.5;x<2.0;x+=0.05) {

            var r = FOOTSIES(b1,b2,-x,adv);

            if (r.r == 1) {

              if (d1 == 0.0) {
                tr = FT.append("tr").style("background-color",i++%2==0?"#222":"#111");

                tr.append("td").text(b2.m).style("background-color",mScale2(i2));
                tr.append("td").text(b2.f[3].si).style("background-color",mScale2(i2));
                tr.append("td").text(1).style("background-color",mScale2(1));

                d1 = x*2;
                tr.append("td").text((x*2).toFixed(1)).style("background-color",dScale1(d1))
                  .datum({x1:-x,adv:adv,m1:m1,m2:m2,f:r.f})
                  .on("mouseenter",FOOTSIESENTER).on("click",FOOTSIESCLICK);

                td2 = tr.append("td").text((x*2).toFixed(1)).style("background-color",dScale1(d1))
                  .datum({x1:-x,adv:adv,m1:m1,m2:m2,f:r.f})
                  .on("mouseenter",FOOTSIESENTER).on("click",FOOTSIESCLICK);

                tr.append("td").text(b1.m).style("background-color",mScale1(i1));

              } else {

                d2 = x*2;
                td2.text((x*2).toFixed(1)).style("background-color",dScale1(d2))
                  .datum({x1:-x,adv:adv,m1:m1,m2:m2,f:r.f})
                  .on("mouseenter",FOOTSIESENTER).on("click",FOOTSIESCLICK);
              }
            } else {
              d1 = 0.0;
            }

          }

        }
      }

    } 
    else if (m2 < 0)    
    {
      adv = m2;

      for (x=0.5;x<2.0;x+=0.05) {

        var b1 = BOXDOX[1][m1];

        var tr = FT.append("tr").style("background-color",i++%2==0?"#222":"#111");
        
        tr.append("td").text(b1.m).style("background-color",mScale1(1));
        tr.append("td").text(-x.toFixed(2)).style("background-color",xScale1(x));

        {
          for (i2=0;i2<um2.length;i2++) {

            m2 = um2[i2];
            var b2 = BOXDOX[2][m2];            


            var r = FOOTSIES(b1,b2,-x,adv);
            tr.append("td").text((x*2).toFixed(1)).classed("R"+r.r,true)
              .datum({x1:-x,adv:adv,m1:m1,m2:m2,f:r.f})
              .on("mouseenter",FOOTSIESENTER).on("click",FOOTSIESCLICK);
          }

          tr.append("td").text(+x.toFixed(2)).style("background-color",xScale2(x));          
          tr.append("td").text(adv).style("background-color",mScale2(1));
        }
      }
    } 
    else
    {
      //i2 = 6;
      //for (i2=0;i2<um1.length;i2++) 
      {
        // var b1 = BOXDOX[1][um1[i1]];
        // var b2 = BOXDOX[2][um2[i2]];

        var b1 = BOXDOX[1][m1];
        var b2 = BOXDOX[2][m2];

        for (x=0.5;x<2.0;x+=0.05) {

          var d1 = x*2;
          var d2 = x*2;
          var tr = FT.append("tr").style("background-color",i++%2==0?"#222":"#111");   
          // tr.append("td").text(i++);
          // tr.append("td").text(um1[i1]).style("background-color",mScale1(i1));
          // tr.append("td").text(um2[i2]).style("background-color",mScale2(i2));
          tr.append("td").text(b1.m).style("background-color",mScale1(i1));
          tr.append("td").text(-x.toFixed(2)).style("background-color",xScale1(x));
          // tr.append("td").text(d1.toFixed(1)).style("background-color",dScale1(d1));

          for (adv=7;adv>=-7;adv-=1) {
            var r = FOOTSIES(b1,b2,-x,adv);
            tr.append("td")
              //.text(r.r)
              .classed("R"+r.r,true)
              //.text(d1.toFixed(1))
              .text(r.h != "" ? r.h : d1.toFixed(1))
              .style("background-color", r.r==1||r.r==10?dScale1(d1):r.r==2||r.r==20?dScale2(d2):"")              
              .datum({x1:-x,adv:adv,m1:m1,m2:m2,f:r.f})
              .on("mouseenter",FOOTSIESENTER).on("click",FOOTSIESCLICK);
          }

          // tr.append("td").text(d2.toFixed(1)).style("background-color",dScale2(d2));
          tr.append("td").text(+x.toFixed(2)).style("background-color",xScale2(x));
          tr.append("td").text(b2.m).style("background-color",mScale2(i2));
        }
      }
    }
  }

  function UCHITBOX(p) {
    var i = -1;
    var th = ["U C", "FRAME"];

    var UC = d3.select("#UC"+p);
    UC.selectAll("*").remove();
    var UCT = UC.append("table").style("width","100%");
    UCT.append("tr").style("color","#999").selectAll("td").data(th).enter().append("td").text(function(d,i){return d;})

    var um = UM(p);

    for (i=0;i<um.length;i++) {
      var m = BOXDOX[p][um[i]];
      var tr = UCT.append("tr").style("background-color",i%2==0?"#222":"#111");      
      var mtd = tr.append("td").append("button").classed("FRAME",true).classed("FRAME"+m.m.charAt(1), true)
        .text(m.m)
        .on("click",function(d,di){
          d3.select(this).classed("UC",!d3.select(this).classed("UC"));
          stage(rparams());
        });
      var mf =[];

      var td = tr.append("td").style("text-align","left");

      for (var f=0;f<m.f.length;f++) {
        
        var frame = m.f[f];
        if (m.f[f].c5.length>0)  {
          var hb = false;
          for (var c=0;c<frame.c5.length;c++) {
            if (frame.c5[c].t!=4 && frame.c5[c].t!=3) {
              hb = true;
            }
          }
          if (hb) {
              var sf = (frame.i+1-2);
              var rf = (frame.s1-frame.sf);
              td.append("button").classed("FRAME",true).classed("FRAME"+m.m.charAt(1), true)
                .text(sf)
                .datum({m:um[i],f:[f]})
                .on("click",function(d,di){
                  d3.select(this).classed("UC",!d3.select(this).classed("UC"));
                  stage(rparams());
                });
              mf.push(f);
              mtd.datum({m:um[i],f:mf});
          }
        }
      }

    }

  }

  function uchit(p) {
    var i = -1, params = rparams();

    var dg = rg;
    var rects = [];
    var rem = rg.select("#UCG"+p).remove();
    var ag = rg.append("g").attr("id","UCG"+p);

    var p12 = d3.select("#P1").select(".MOVEP2").classed("UC");
    var p21 = d3.select("#P2").select(".MOVEP1").classed("UC");

    // var x1 = p12 ? -params.x1-2 : +params.x1+2;
    // var x2 = p21 ? +params.x1+2 : -params.x1-2;

    var UCB = d3.select("#UC"+p).selectAll(".UC");

    UCB.each(function(d,di){

      if (d == null) return;

      var b1 = BOXDOX[1][d.m + (d.m<BOXLEN?1:-1) * (p12 ? BOXLEN :0)];
      var b2 = BOXDOX[2][d.m + (d.m<BOXLEN?1:-1) * (p21 ? BOXLEN :0)];

      var x1 = p12 ? -params.x1-b1.x : +params.x1-b1.x;
      var x2 = p21 ? +params.x1-b2.x : -params.x1-b2.x;

      var m = p == 1 ? b1 : b2;//BOXDOX[p][um[i]];
      var dg = ag.append("g");

      rects = [];

      for (i=0;i<d.f.length;i++) {
        var f=d.f[i];        
        var frame = m.f[f];

        if (m.f[f].c6.length>0)  {
          for (var c=0;c<frame.c6.length;c++) {
            if (frame.c6[c].t!=4) {
              frame.c6[c].c="ucblue";
              rects.push(frame.c6[c]);
            }
          }
        }        
        if (m.f[f].c5.length>0)  {
          for (var c=0;c<frame.c5.length;c++) {
            if (frame.c5[c].t!=4 && frame.c5[c].t!=3) {
              frame.c5[c].c="ucred";
              rects.push(frame.c5[c]);
            }
          }
        }
      }

      if (p == 1) {
        dg.selectAll("rect").data(rects).enter().append("rect")
          .attr("class", function(d) {return d.c;})
          .attr("x", function(d) { return (x1)+d.rx; })
          .attr("y", function(d) { return -d.ry-d.rh; })
          .attr("height", function(d) { return d.rh; })
          .attr("width", function(d) { return d.rw; });
      } else if (p == 2) {
        dg.selectAll("rect").data(rects).enter().append("rect")
          .attr("class", function(d) {return d.c;})
          .attr("x", function(d) { return (x2)+d.rx; })
          .attr("y", function(d) { return -d.ry-d.rh; })
          .attr("height", function(d) { return d.rh; })
          .attr("width", function(d) { return d.rw; });
      }

    });

  }

  function allhit(p) {
    var i = -1, params = rparams();

    var dg = rg;
    var rects = [];
    var rem = rg.select("#ALL"+p).remove();
    //console.log(rem.empty());
    if (!rem.empty()) {
      d3.select("#P"+p).select(".MOVEALL").classed("UC",false);
      return;
    }
    var ag = rg.append("g").attr("id","ALL"+p);

    var um = UM(p);

    var p12 = d3.select("#P1").select(".MOVEP2").classed("UC");
    var p21 = d3.select("#P2").select(".MOVEP1").classed("UC");

    // var x1 = p12 ? -params.x1-2 : +params.x1+2;
    // var x2 = p21 ? +params.x1+2 : -params.x1-2;

    for (i=0;i<um.length;i++) {


      var b1 = BOXDOX[1][um[i] + (um[i]<BOXLEN?1:-1) * (p12 ? BOXLEN :0)];
      var b2 = BOXDOX[2][um[i] + (um[i]<BOXLEN?1:-1) * (p21 ? BOXLEN :0)];

      var x1 = p12 ? -params.x1-b1.x : +params.x1-b1.x;
      var x2 = p21 ? +params.x1-b2.x : -params.x1-b2.x;

      var m = p == 1 ? b1 : b2;//BOXDOX[p][um[i]];
      var dg = ag.append("g");

      rects = [];
      for (var f=0;f<m.f.length;f++) {
        
        var frame = m.f[f];
        if (m.f[f].c5.length>0)  {
          for (var c=0;c<frame.c5.length;c++) {
            if (frame.c5[c].t!=4 && frame.c5[c].t!=3) {
              frame.c5[c].c="allred";
              rects.push(frame.c5[c]);
            }
          }          
        }
      }

      if (p == 1) {
        dg.selectAll("rect").data(rects).enter().append("rect")
          .attr("class", function(d) {return d.c;})
          .attr("x", function(d) { return (x1)+d.rx; })
          .attr("y", function(d) { return -d.ry-d.rh; })
          .attr("height", function(d) { return d.rh; })
          .attr("width", function(d) { return d.rw; });
      } else if (p == 2) {
        dg.selectAll("rect").data(rects).enter().append("rect")
          .attr("class", function(d) {return d.c;})
          .attr("x", function(d) { return (x2)+d.rx; })
          .attr("y", function(d) { return -d.ry-d.rh; })
          .attr("height", function(d) { return d.rh; })
          .attr("width", function(d) { return d.rw; });
      }

    }

  }

  function update(f) {
    var fpath = d3.select("#fpath").remove();
    var fg = d3.select("#fg"+f);

    if (!fg.empty()) {
      if (fpath.empty())           
        fg.append("path").attr("id", "fpath")
        .attr("d", d3.svg.line()([[-2,0],[2,0]].map(function(p){return [p[0],p[1]];})) + "Z");
      else
        fg.append(function(){return fpath.node();});
    }

    prop("f",f);
    stage(rparams());
  };

  function stage(params) {
    var points = [[-2,0],[0,0],[2,0]];
    if (params.f != null) {

      var dg = rg;
      var rects = [];
      dg.selectAll("*").remove();

      var p12 = d3.select("#P1").select(".MOVEP2").classed("UC");
      var p21 = d3.select("#P2").select(".MOVEP1").classed("UC");

      var b1 = BOXDOX[1][+params.m1 + (+params.m1<BOXLEN?1:-1) * (p12 ? BOXLEN :0)];
      var b2 = BOXDOX[2][+params.m2 + (+params.m2<BOXLEN?1:-1) * (p21 ? BOXLEN :0)];

      var x1 = p12 ? -params.x1-b1.x : +params.x1-b1.x;
      var x2 = p21 ? +params.x1-b2.x : -params.x1-b2.x;

      var f = Math.floor(params.f);
      var adv = Math.floor(params.adv);
      var f1 = f;
      var f2 = f;
      if (adv > 0) f2 -= adv;
      if (adv < 0) f1 += adv;
      if (f1 < 0) f1 = 0;
      if (f2 < 0) f2 = 0;
      if (f1 > b1.f.length-1) f1 = b1.f.length-1;
      if (f2 > b2.f.length-1) f2 = b2.f.length-1;

      dg.append("text")
        .text(f-1)
        .attr("fill","#999")
        .attr("text-anchor","middle")
        .attr("transform", "translate(0,0.2)scale(0.015)");

      frame = b1.f[f1];
      dg.append("text")
        .text(formatadv( params.adv) + " ADV . " + (frame.s0 > 0 ? (frame.s0+1)+"F . ": "") + frame.s + " " + (frame.sf+1) + (frame.sf == frame.s1 ? " IASA" : frame.sf > frame.s1 ? " +":""))
        .attr("fill","#999")
        .attr("text-anchor","middle")
        .attr("transform", "translate(-2,0.2)scale(0.015)");

      frame = b2.f[f2];
      dg.append("text")
        .text(formatadv(-params.adv) + " ADV . " + (frame.s0 > 0 ? (frame.s0+1)+"F . ": "") + frame.s + " " + (frame.sf+1) + (frame.sf == frame.s1 ? " IASA" : frame.sf > frame.s1 ? " +":""))
        .attr("fill","#999")
        .attr("text-anchor","middle")
        .attr("transform", "translate(2,0.2)scale(0.015)");

      frame = b1.f[f1];
      for (var c=0;c<frame.c6.length;c++) {
        frame.c6[c].c=frame.c6[c].t!=4?"blue":"cyan";
        rects.push(frame.c6[c]);
      }
      for (var c=0;c<frame.c5.length;c++) {
        frame.c5[c].c=(frame.c5[c].t!=4 && frame.c5[c].t!=3)?"red":"gray";
        rects.push(frame.c5[c]);
      }
      dg.selectAll("rect").data(rects).enter().append("rect")
        .attr("class", function(d) {return d.c;})
        .attr("x", function(d) { return (x1)+d.rx; })
        .attr("y", function(d) { return -d.ry-d.rh; })
        .attr("height", function(d) { return d.rh; })
        .attr("width", function(d) { return d.rw; });

      frame = b2.f[f2];
      for (var c=0;c<frame.c6.length;c++) {
        frame.c6[c].c=frame.c6[c].t!=4?"p2blue":"p2cyan";
        rects.push(frame.c6[c]);
      }
      for (var c=0;c<frame.c5.length;c++) {
        frame.c5[c].c=(frame.c5[c].t!=4 && frame.c5[c].t!=3)?"p2red":"p2gray";
        rects.push(frame.c5[c]);
      }
      dg.selectAll("rect").data(rects).enter().append("rect")
        .attr("class", function(d) {return d.c;})
        .attr("x", function(d) { return (x2)+d.rx; })
        .attr("y", function(d) { return -d.ry-d.rh; })
        .attr("height", function(d) { return d.rh; })
        .attr("width", function(d) { return d.rw; });

      if (d3.select("#P"+1).select(".MOVEALL").classed("UC")) {
        allhit(1);
      }
      if (d3.select("#P"+2).select(".MOVEALL").classed("UC")) {
        allhit(2);
      }
      uchit(1);
      uchit(2);

    } 
    return d3.svg.line()(points.map(function(p){return [p[0],p[1]];})) + "Z";
  }

  function render(params) {
    var i = -1, points = [[-2,0],[0,0],[2,0]];

    if (params.f != null) {
      stage(params);
    }
    if (params.f != null) {
      
      var rects = [];
      fg.selectAll("*").remove();

      var b1 = BOXDOX[1][params.m1];
      var b2 = BOXDOX[2][params.m2];
      //var f = Math.floor(params.f);
      var adv = Math.floor(params.adv);

      for (i=0;i<30;i++) {

        var f = i+2;

        rects = [];
        var dg = fg.append("g")
                  .attr("id", "fg"+f)
                  .attr("transform", "translate("+((i%10)*100+25)+","+(325+Math.floor(i/10)*75)+")scale(20)")
                  .datum(f)
                  .on("mouseover",function(){
                    //if (d3.selectAll(".MOVEHOVER").classed("UC")==false) return;
                    var df = d3.select(this).datum();
                    update(df);
                  })
                  .on("click",function(){
                    //d3.selectAll(".MOVEHOVER").classed("UC",false);
                    d3.select("#f").select("input").node().focus();
                  });

        if (f == params.f) {
          dg.append("path").attr("id", "fpath")
          .attr("d", d3.svg.line()(points.map(function(p){return [p[0],p[1]];})) + "Z");
        }

        dg.append("text")
          .text(f-1)
          .attr("fill","#999")
          .attr("text-anchor","middle")
          .attr("transform", "translate(0,0.5)scale(0.04)");

        var f1 = f;
        var f2 = f;
        if (adv > 0) f2 -= adv;
        if (adv < 0) f1 += adv;
        if (f1 < 0) f1 = 0;
        if (f2 < 0) f2 = 0;
        if (f1 > b1.f.length-1) f1 = b1.f.length-1;
        if (f2 > b2.f.length-1) f2 = b2.f.length-1;

        frame = b1.f[f1];
        for (var c=0;c<frame.c6.length;c++) {
          frame.c6[c].c=frame.c6[c].t!=4?"blue":"cyan";
          rects.push(frame.c6[c]);
        }
        for (var c=0;c<frame.c5.length;c++) {
          frame.c5[c].c=(frame.c5[c].t!=4 && frame.c5[c].t!=3)?"red":"";
          rects.push(frame.c5[c]);
        }
        dg.selectAll("rect").data(rects).enter().append("rect")
          .attr("class", function(d) {return d.c;})
          .attr("x", function(d) { return (+params.x1-b1.x)+d.rx; })
          .attr("y", function(d) { return -d.ry-d.rh; })
          .attr("height", function(d) { return d.rh; })
          .attr("width", function(d) { return d.rw; });

        frame = b2.f[f2];
        for (var c=0;c<frame.c6.length;c++) {
          frame.c6[c].c=frame.c6[c].t!=4?"p2blue":"p2cyan";
          rects.push(frame.c6[c]);
        }
        for (var c=0;c<frame.c5.length;c++) {
          frame.c5[c].c=(frame.c5[c].t!=4 && frame.c5[c].t!=3)?"p2red":"";
          rects.push(frame.c5[c]);
        }
        dg.selectAll("rect").data(rects).enter().append("rect")
          .attr("class", function(d) {return d.c;})
          .attr("x", function(d) { return (-params.x1-b2.x)+d.rx; })
          .attr("y", function(d) { return -d.ry-d.rh; })
          .attr("height", function(d) { return d.rh; })
          .attr("width", function(d) { return d.rw; });
      }

    }    
    return d3.svg.line()(points.map(function(p){return [p[0],p[1]];})) + "Z";
  }

</script>
<script>

var format = d3.format(".4n");
var formatadv = d3.format("+");

function formatkv(k,v) {
  if (k == "m1" || k == "m2")        
    return v; // + " " + BOXDOX[v].m;
  else if (k == "f")
    return v-1;
  else if (k == "adv")
    return formatadv(v);
  else
    return format(v);
}

// var scale = d3.scale.linear()
//     .domain([-10, 20, 1000])
//     .range([0, 800, 1000]);

var scale = d3.scale.linear();

var svg = d3.select("#svg")
  .append("svg").attr("id","BOXDOX")
    .attr("width", 960)
    .attr("height", 500);


var defaults = {m1:0,m2:BOXLEN,adv:0,x1:-1.5,f:-2};

var path = svg.append("path")
    .attr("class", "big")
    .attr("transform", "translate(480,250)scale(100)")
    .attr("d", d3.svg.line()([[-2,0],[0,0],[2,0]].map(function(p){return [p[0],p[1]];})) + "Z");

var rg = svg.append("g")
    .attr("class", "big")
    .attr("transform", "translate(480,250)scale(100)");

var fg = svg.append("g")
    //.attr("class", "big")
    //.attr("transform", "translate(960,250)scale(50)");    

var control = d3.select("#controls")
  .selectAll("div")
    .data(d3.entries(defaults))
  .enter().append("div")
    .attr("id", function(d) { return d.key; });

control.append("label")
    .text(function(d) { return d.key.toUpperCase(); });

control.append("input")
    .attr("type", "range")
    .attr("max", 100)
    .attr("min", -110)
    .attr("step", 0.05)
    .attr("value", function(d) { 
      return (d.value); })
    .property("value", function(d) { 
      return (d.value); })
    .on("input", function(d) {
      var v = this.value; //scale.invert(this.value);
      //var v = scale(this.value);
      // if (d.key == "m1")
      //   footsies(v,d3.select("#m2").select("input").property("value"));
      // else if (d.key == "m2")
      //   footsies(d3.select("#m1").select("input").property("value"),v);
      if (d.key == "f")
        stage(rparams());
      else
        render(rparams());

      if (d.key == "m1" || d.key == "m2") {
        if (!UCME) UCFOOTSIES(prop("m1"),prop("m2"));
        else if (UCME && d.key == "m1") UCFOOTSIES(prop("m1"),-3);
        else if (UCME && d.key == "m2") UCFOOTSIES(-3,prop("m2"));
      }

      d3.select(this.nextSibling).text(formatkv(d.key,v));
    });

control.append("span")
    .text(function(d) { return formatkv(d.key, d.value); });

d3.select("#m1").select("input").attr("min", 0).attr("max", BOXLEN*2-1).attr("step", 1);
d3.select("#m2").select("input").attr("min", 0).attr("max", BOXLEN*2-1).attr("step", 1);
d3.select("#x1").select("input").attr("min", -3).attr("max", -0.5).attr("step", 0.05);
d3.select("#adv").select("input").attr("min", -100).attr("max", 100).attr("step", 1).style("transform","rotateY(180deg)");
d3.select("#f").select("input").attr("min", -1).attr("max", 100).attr("step", 1);

if (UCME) cload("KRN",1);


</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-72771119-1', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>