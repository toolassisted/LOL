<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>SFV FOOTSIES LOL</title>
<style>

  body {
    background-color: #000;
    color: #fff;
  }

  path {
    stroke-width: 1px;
    stroke: #333;
    fill: #ddd;
    vector-effect: non-scaling-stroke;
  }

  #BOXDOX rect {
    stroke-width: 1px;
    /*stroke: #333;*/
    fill: none;
    /*opacity: 0.8;*/
    mix-blend-mode: screen;
    vector-effect: non-scaling-stroke;
  }

  #ALL1 rect, #ALL2 rect {
    /*stroke-width: 1px;*/
    /*stroke: #333;*/
    /*fill: none;*/
    /*opacity: 0.8;*/
    /*mix-blend-mode: normal;*/
    /*vector-effect: non-scaling-stroke;*/
  }

  .fgray { fill: #111;}
  .fred { fill: #300; }
  .fgreen { fill: #030; }
  .fblue { fill: #003; }
  .fcyan { fill: #033; }
  .fyellow { fill: #330; }

  .hred { fill: #600; }
  .hgreen { fill: #060; }
  .hblue { fill: #006; }
  .hcyan { fill: #066; }
  .hyellow { fill: #660; }

  .gray { stroke: #333; }
  .red { stroke: #f00; }
  .green { stroke: #0f0; }
  .blue { stroke: #00f; }
  .cyan { stroke: #0ff; }

  .p2gray { stroke: #333; }
  .p2red { stroke: #f66; }
  .p2green { stroke: #6f6; }
  .p2blue { stroke: #66f; }
  .p2cyan { stroke: #6ff; }

  #buttons {
    width: 70%;
    float: left;
    padding-left: 5%;
  }

  #controls {
    width: 100%;
    /*float: left;*/
    margin-top: 10px;
  }

  #controls div{
    white-space: nowrap;
    display: inline-block;
  }

  #controls, #buttons, #BOXDOX text {
    /*position: absolute;*/
    /*width: 240px*/;
    font: 10px sans-serif;
  }

  #controls span, #buttons span,
  #controls label, #buttons label {
    position: relative;
    top: -5px;
    padding: 5px;
    display: inline-block;
    width: 20px;
  }

  #buttons button {
    font: 10px sans-serif;
    padding: 5px;
    width: 70px;
  }

  #buttons .buttons {
    width: 50%;
    float: left;
  }

  .LOL text {
    text-anchor: middle;
    fill: #999;
    font: 8px sans-serif;
  }

  .LOL rect:hover {
    stroke: #fff;
  }

  #svg {
    text-align: center;
  }
</style>
<style type="text/css">

  div#PLAYERS {
    width: 100%;
    text-align: center;
  }
  div.PLAYER {
    width: 45%;
    display: inline-block;
  }
  div.ROW {    
    white-space: nowrap;
  }
  .MOVES div:nth-of-type(3), .MOVES div:nth-of-type(5) {
    padding-top: 10px;
  }


  button.CHAR {
    padding: 5px;
    margin: 3px;
    width: 8%;
    background-color: #999;
  }
  button.MOVE {
    padding: 7px;
    margin: 3px;
    /*width: 5%;*/
    /*font-size: 10px;*/
    background-color: #eee;
  }  
  button.MOVE:nth-of-type(3), button.MOVE:nth-of-type(6) {
    margin-right: 10px;
  }
  button.DUP {
    background-color: #999;
  }
  button.SEL {
    background-color: #ffc;
  }

  .MOVES {
    padding-top: 10px;
  }
</style>
</head>
<body>
<div id="PLAYERS">
<div id="P1" class="PLAYER"><div class="CHARS"></div><div class="MOVES"></div></div>
<div id="P2" class="PLAYER"><div class="CHARS"></div><div class="MOVES"></div></div>
<div id="controls"></div>
</div>
<div id="svg"></div>

<script src="d3.min.js"></script>
<script>

  var BOXDOX = [[],[],[]];
  var CHARS = [
  ["BLR", "BLR2", "BRD", "CMY", "CNL", "CNL2", "DSM", "FAN", "KEN", "KRN"],
  ["LAR", "NCL", "NCL2", "NSH", "RMK", "RSD", "RYU", "RYU2", "VEG", "ZGF"],
  ];
  var MOVES = [
//  ["4T", "5T", "ALL", "ADV0", "ADV+", "ADV-", "ADV=", "F-", "F+"],
  ["4LP", "4MP", "4HP", "5LP", "5MP", "5HP", "6LP", "6MP", "6HP"],
  ["4LK", "4MK", "4HK", "5LK", "5MK", "5HK", "6LK", "6MK", "6HK"],
  ["1LP", "1MP", "1HP", "2LP", "2MP", "2HP", "3LP", "3MP", "3HP"],
  ["1LK", "1MK", "1HK", "2LK", "2MK", "2HK", "3LK", "3MK", "3HK"],
  ["4T", "5T", "ALL", "ADV0", "ADV+", "ADV-", "ADV=", "F-", "F+"],
  ];

  var CDIV = d3.selectAll(".CHARS").datum(function(d,i){return i+1;});
  CDIV.selectAll("div").data(CHARS).enter().append("div").attr("class","ROW")
      .selectAll("button").data(function(d){return d;}).enter().append("button").attr("class","CHAR")
      .on("click",function(d,i){
        var p = d3.select(this.parentNode.parentNode).datum();
        d3.select("#P"+p).selectAll(".CHAR").classed("SEL",false);
        d3.select(this).classed("SEL",true);
        cload(d,p);
      })
      .text(function(d,i){return d;});

  var MDIV = d3.selectAll(".MOVES").datum(function(d,i){return i+1;});
  MDIV.selectAll("div").data(MOVES).enter().append("div").attr("class","ROW")
      .selectAll("button").data(function(d){return d;}).enter().append("button").attr("class", function(d,i){return "MOVE MOVE" + d + " DUP"})
      .on("click", function(d,i) { 
        var p = d3.select(this.parentNode.parentNode).datum();

        // console.log(p,d,i);
        var m = BOXDOX[p].filter(function(e,i){ return e.p == p-1 && e.m == d;});
        
        if (m.length == 0) { 
          // console.log(m);
          if (d == "ALL") {
            //d3.select("#P"+p).selectAll("button.MOVE").classed("SEL",false);
            d3.select(this).classed("SEL",true);
            allhit(p);
          } else if (d == "ADV0") {
            prop("adv", 0);
            d3.select("#adv").select("input").node().focus();
            render(rparams());
          } else if (d == "ADV-") {            
            var pv = 1*prop("adv"); prop("adv", pv-1);
            d3.select("#f").select("input").node().focus();
            render(rparams());
          } else if (d == "ADV+") {
            var pv = 1*prop("adv"); prop("adv", pv+1);
            d3.select("#f").select("input").node().focus();
            render(rparams());
          } else if (d == "F-") {            
            var pv = 1*prop("f"); prop("f", pv-1);
            d3.select("#f").select("input").node().focus();
            render(rparams());
          } else if (d == "F+") {
            var pv = 1*prop("f"); prop("f", pv+1);
            d3.select("#f").select("input").node().focus();
            render(rparams());
          } else if (d == "ADV=") {

            var s1 = mhit1(BOXDOX[1][1*prop("m1")]);
            var s2 = mhit1(BOXDOX[2][1*prop("m2")]);
            var adv = 1*prop("adv");
            var s0 = s1-s2;
            prop("adv", s0);
            if (s0<0) prop("f", s2+2);
            else if (s0>0) prop("f", s1+2);
            d3.select("#adv").select("input").node().focus();
            render(rparams());
          }
          return;
        }

        d3.select("#P"+p).selectAll("button.MOVE").classed("SEL",false);
        d3.select(this).classed("SEL",true);

        var s0 = mhit1(m[0]);
        prop("m"+p, m[0].i);

        var adv = 1*prop("adv");
        if (p==1) prop("f", s0+2+(adv<0 && s0+2>adv?-adv:0));
        else if (p==2) prop("f", s0+2+(adv<0?0:adv));
        d3.select("#f").select("input").node().focus();
        render(rparams());

      } )
      .text(function(d,i){return d;})

  function mhit1(m) {
    var s0 = m.f[2].s0;
    if (s0 == 0 || s0 != m.f[3].s0) {
      var s0f = m.f.filter(function(e,i){ return e.c5.filter(function(c){ return c.t!=4; }).length > 0; });
      if (s0f.length>0) s0 = s0f[0].sf;
    }
    return s0;
  }

  function prop(p,v) {
    if (arguments.length == 1) return d3.select("#"+p).select("input").property("value");
    d3.select("#"+p).select("input").property("value", v);
    d3.select("#"+p).select("span").text(formatkv(p,v));
  }

  function cload(c,p) {

    console.log(c,p);

    d3.text("LOL_"+c+"_"+c+".json", function(error,data) {

      if (error!=null) return;

      BOXDOX[p] = eval(data);
      if (BOXDOX[1].length == 0) BOXDOX[1] = BOXDOX[p];
      if (BOXDOX[2].length == 0) BOXDOX[2] = BOXDOX[p];
      render(rparams());

      var dup = [];
      var mb = {};
      var mblen = 0;
      BOXDOX[p].forEach(function(m,mi){
        // if (m.f[0].sf != 17) console.log(m);
        if (dup.indexOf(m.f[2].s) >= 0) ;//console.log(m);
        else dup.push(m.f[2].s);

        if (mb[m.f[2].s] && mb[m.f[2].s].indexOf(m.m) < 0) { mb[m.f[2].s].push(m.m); mblen++; }
        else { mb[m.f[2].s] = [m.m]; mblen++; }
      });

      for (var key in mb) {
        var m = mb[key]
        // console.log(key, m);
        m.forEach(function(b,bi){
          if (bi==0) { d3.select("#P"+p).selectAll(".MOVE"+b).classed("DUP",false); }
          else { d3.select("#P"+p).selectAll(".MOVE"+b).classed("DUP",true); }
        });
      }

      //d3.select("#P"+p).selectAll("button.MOVE").classed("SEL",false);

      if (d3.select("#P"+p).select(".MOVEALL").classed("SEL")) {
        allhit(p);
      }

    });

  }

  function rparams() {

    return {
        m1: d3.select("#m1").select("input").property("value"), 
        m2: d3.select("#m2").select("input").property("value"), 
        adv: d3.select("#adv").select("input").property("value"), 
        x1: d3.select("#x1").select("input").property("value"), 
        f: d3.select("#f").select("input").property("value"), 
        };
  }

  function allhit(p) {
    var i = -1, params = rparams();

    var dg = rg;
    var rects = [];
    rg.select("#ALL"+p).remove();
    var ag = rg.append("g").attr("id","ALL"+p);


    var dup = [];
    var mb = {};
    var mblen = 0;
    var um = [];
    BOXDOX[p].forEach(function(m,mi){
      if (m.p+1!=p) 
        return;

      if (dup.indexOf(m.f[2].s) >= 0) ;
      else dup.push(m.f[2].s);

      if (mb[m.f[2].s] && mb[m.f[2].s].indexOf(m.m) < 0) { mb[m.f[2].s].push(m.i); mblen++; }
      else { mb[m.f[2].s] = [m.i]; mblen++; um.push(m.i); }
    });

    for (i=0;i<um.length;i++) {

      var m = BOXDOX[p][um[i]];
      var dg = ag.append("g");

      rects = [];
      for (var f=0;f<m.f.length;f++) {
        
        var frame = m.f[f];
        if (m.f[f].c5.length>0)  {
          for (var c=0;c<frame.c5.length;c++) {
            if (frame.c5[c].t!=4 && frame.c5[c].t!=3) {
              frame.c5[c].c="red";
              rects.push(frame.c5[c]);
            }
          }          
        }
      }

      if (p == 1) {
        dg.selectAll("rect").data(rects).enter().append("rect")
          .attr("class", function(d) {return d.c;})
          .attr("x", function(d) { return (+params.x1+2)+d.rx; })
          .attr("y", function(d) { return -d.ry-d.rh; })
          .attr("height", function(d) { return d.rh; })
          .attr("width", function(d) { return d.rw; });
      } else if (p == 2) {
        dg.selectAll("rect").data(rects).enter().append("rect")
          .attr("class", function(d) {return d.c;})
          .attr("x", function(d) { return (-params.x1-2)+d.rx; })
          .attr("y", function(d) { return -d.ry-d.rh; })
          .attr("height", function(d) { return d.rh; })
          .attr("width", function(d) { return d.rw; });
      }

    }

  }

  function update(f) {
    var fpath = d3.select("#fpath").remove();
    var fg = d3.select("#fg"+f);

    if (!fg.empty()) {
      if (fpath.empty())           
        fg.append("path").attr("id", "fpath")
        .attr("d", d3.svg.line()([[-2,0],[2,0]].map(function(p){return [p[0],p[1]];})) + "Z");
      else
        fg.append(function(){return fpath.node();});
    }

    prop("f",f);
    stage(rparams());
  };

  function stage(params) {
    var points = [[-2,0],[0,0],[2,0]];
    if (params.f != null) {

      var dg = rg;
      var rects = [];
      dg.selectAll("*").remove();

      var b1 = BOXDOX[1][params.m1];
      var b2 = BOXDOX[2][params.m2];
      var f = Math.floor(params.f);
      var adv = Math.floor(params.adv);
      var f1 = f;
      var f2 = f;
      if (adv > 0) f2 -= adv;
      if (adv < 0) f1 += adv;
      if (f1 < 0) f1 = 0;
      if (f2 < 0) f2 = 0;
      if (f1 > b1.f.length-1) f1 = b1.f.length-1;
      if (f2 > b2.f.length-1) f2 = b2.f.length-1;

      dg.append("text")
        .text(f-1)
        .attr("fill","#999")
        .attr("text-anchor","middle")
        .attr("transform", "translate(0,0.2)scale(0.015)");

      frame = b1.f[f1];
      dg.append("text")
        .text(formatadv( params.adv) + " ADV . " + (frame.s0 > 0 ? (frame.s0+1)+"F . ": "") + frame.s + " " + (frame.sf+1) + (frame.sf == frame.s1 ? " IASA" : frame.sf > frame.s1 ? " +":""))
        .attr("fill","#999")
        .attr("text-anchor","middle")
        .attr("transform", "translate(-2,0.2)scale(0.015)");

      frame = b2.f[f2];
      dg.append("text")
        .text(formatadv(-params.adv) + " ADV . " + (frame.s0 > 0 ? (frame.s0+1)+"F . ": "") + frame.s + " " + (frame.sf+1) + (frame.sf == frame.s1 ? " IASA" : frame.sf > frame.s1 ? " +":""))
        .attr("fill","#999")
        .attr("text-anchor","middle")
        .attr("transform", "translate(2,0.2)scale(0.015)");

      frame = b1.f[f1];
      for (var c=0;c<frame.c6.length;c++) {
        frame.c6[c].c=frame.c6[c].t!=4?"blue":"cyan";
        rects.push(frame.c6[c]);
      }
      for (var c=0;c<frame.c5.length;c++) {
        frame.c5[c].c=(frame.c5[c].t!=4 && frame.c5[c].t!=3)?"red":"gray";
        rects.push(frame.c5[c]);
      }
      dg.selectAll("rect").data(rects).enter().append("rect")
        .attr("class", function(d) {return d.c;})
        .attr("x", function(d) { return (+params.x1+2)+d.rx; })
        .attr("y", function(d) { return -d.ry-d.rh; })
        .attr("height", function(d) { return d.rh; })
        .attr("width", function(d) { return d.rw; });

      frame = b2.f[f2];
      for (var c=0;c<frame.c6.length;c++) {
        frame.c6[c].c=frame.c6[c].t!=4?"p2blue":"p2cyan";
        rects.push(frame.c6[c]);
      }
      for (var c=0;c<frame.c5.length;c++) {
        frame.c5[c].c=(frame.c5[c].t!=4 && frame.c5[c].t!=3)?"p2red":"p2gray";
        rects.push(frame.c5[c]);
      }
      dg.selectAll("rect").data(rects).enter().append("rect")
        .attr("class", function(d) {return d.c;})
        .attr("x", function(d) { return (-params.x1-2)+d.rx; })
        .attr("y", function(d) { return -d.ry-d.rh; })
        .attr("height", function(d) { return d.rh; })
        .attr("width", function(d) { return d.rw; });

    } 
    return d3.svg.line()(points.map(function(p){return [p[0],p[1]];})) + "Z";
  }

  function render(params) {
    var i = -1, points = [[-2,0],[0,0],[2,0]];

    if (params.f != null) {
      stage(params);
    }
    if (params.f != null) {
      
      var rects = [];
      fg.selectAll("*").remove();

      var b1 = BOXDOX[1][params.m1];
      var b2 = BOXDOX[2][params.m2];
      //var f = Math.floor(params.f);
      var adv = Math.floor(params.adv);

      for (i=0;i<30;i++) {

        var f = i+2;

        rects = [];
        var dg = fg.append("g")
                  .attr("id", "fg"+f)
                  .attr("transform", "translate("+((i%10)*100+25)+","+(325+Math.floor(i/10)*75)+")scale(20)")
                  .datum(f)
                  .on("mouseover",function(){
                    var df = d3.select(this).datum();
                    //console.log(df);
                    update(df);
                  })
                  .on("click",function(){
                    d3.select("#f").select("input").node().focus();
                  });

        if (f == params.f) {
          dg.append("path").attr("id", "fpath")
          .attr("d", d3.svg.line()(points.map(function(p){return [p[0],p[1]];})) + "Z");
        }

        dg.append("text")
          .text(f-1)
          .attr("fill","#999")
          .attr("text-anchor","middle")
          .attr("transform", "translate(0,0.5)scale(0.04)");

        var f1 = f;
        var f2 = f;
        if (adv > 0) f2 -= adv;
        if (adv < 0) f1 += adv;
        if (f1 < 0) f1 = 0;
        if (f2 < 0) f2 = 0;
        if (f1 > b1.f.length-1) f1 = b1.f.length-1;
        if (f2 > b2.f.length-1) f2 = b2.f.length-1;

        frame = b1.f[f1];
        for (var c=0;c<frame.c6.length;c++) {
          frame.c6[c].c=frame.c6[c].t!=4?"blue":"cyan";
          rects.push(frame.c6[c]);
        }
        for (var c=0;c<frame.c5.length;c++) {
          frame.c5[c].c=(frame.c5[c].t!=4 && frame.c5[c].t!=3)?"red":"";
          rects.push(frame.c5[c]);
        }
        dg.selectAll("rect").data(rects).enter().append("rect")
          .attr("class", function(d) {return d.c;})
          .attr("x", function(d) { return (+params.x1+2)+d.rx; })
          .attr("y", function(d) { return -d.ry-d.rh; })
          .attr("height", function(d) { return d.rh; })
          .attr("width", function(d) { return d.rw; });

        frame = b2.f[f2];
        for (var c=0;c<frame.c6.length;c++) {
          frame.c6[c].c=frame.c6[c].t!=4?"p2blue":"p2cyan";
          rects.push(frame.c6[c]);
        }
        for (var c=0;c<frame.c5.length;c++) {
          frame.c5[c].c=(frame.c5[c].t!=4 && frame.c5[c].t!=3)?"p2red":"";
          rects.push(frame.c5[c]);
        }
        dg.selectAll("rect").data(rects).enter().append("rect")
          .attr("class", function(d) {return d.c;})
          .attr("x", function(d) { return (-params.x1-2)+d.rx; })
          .attr("y", function(d) { return -d.ry-d.rh; })
          .attr("height", function(d) { return d.rh; })
          .attr("width", function(d) { return d.rw; });
      }

    }    
    return d3.svg.line()(points.map(function(p){return [p[0],p[1]];})) + "Z";
  }

</script>
<script>

var format = d3.format(".4n");
var formatadv = d3.format("+");

function formatkv(k,v) {
  if (k == "m1" || k == "m2")        
    return v; // + " " + BOXDOX[v].m;
  else if (k == "f")
    return v-1;
  else if (k == "adv")
    return v;
  else
    return format(v);
}

// var scale = d3.scale.linear()
//     .domain([-10, 20, 1000])
//     .range([0, 800, 1000]);

var scale = d3.scale.linear();

var svg = d3.select("#svg")
  .append("svg").attr("id","BOXDOX")
    .attr("width", 960)
    .attr("height", 500);

var defaults = {m1:1,m2:39,adv:0,x1:-1.5,f:-2};

var path = svg.append("path")
    .attr("class", "big")
    .attr("transform", "translate(480,250)scale(100)")
    .attr("d", d3.svg.line()([[-2,0],[0,0],[2,0]].map(function(p){return [p[0],p[1]];})) + "Z");

var rg = svg.append("g")
    .attr("class", "big")
    .attr("transform", "translate(480,250)scale(100)");

var fg = svg.append("g")
    //.attr("class", "big")
    //.attr("transform", "translate(960,250)scale(50)");    

var control = d3.select("#controls")
  .selectAll("div")
    .data(d3.entries(defaults))
  .enter().append("div")
    .attr("id", function(d) { return d.key; });

control.append("label")
    .text(function(d) { return d.key.toUpperCase(); });

control.append("input")
    .attr("type", "range")
    .attr("max", 100)
    .attr("min", -110)
    .attr("step", 0.05)
    .attr("value", function(d) { 
      return (d.value); })
    .property("value", function(d) { 
      return (d.value); })
    .on("input", function(d) {
      var v = this.value; //scale.invert(this.value);
      //var v = scale(this.value);
      // if (d.key == "m1")
      //   footsies(v,d3.select("#m2").select("input").property("value"));
      // else if (d.key == "m2")
      //   footsies(d3.select("#m1").select("input").property("value"),v);
      if (d.key == "f")
        stage(rparams());
      else
        render(rparams());

      d3.select(this.nextSibling).text(formatkv(d.key,v));
    });

control.append("span")
    .text(function(d) { return formatkv(d.key, d.value); });

d3.select("#m1").select("input").attr("min", 0).attr("max", 75).attr("step", 1);
d3.select("#m2").select("input").attr("min", 0).attr("max", 75).attr("step", 1);
d3.select("#x1").select("input").attr("min", -3).attr("max", -0.5).attr("step", 0.05);
d3.select("#adv").select("input").attr("min", -20).attr("max", 20).attr("step", 1).style("transform","rotateY(180deg)");
d3.select("#f").select("input").attr("min", -1).attr("max", 100).attr("step", 1);

</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-72771119-1', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>
